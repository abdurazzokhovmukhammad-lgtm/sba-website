<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SBA Marketplace</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#ffffff;--brand:#5b0b0b;--accent:#0e9f6e;--text:#111;}
  body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:var(--text)}
  .header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:4px solid var(--brand)}
  .logo{font-weight:800;color:#000}
  .searchWrap{flex:1;display:flex;justify-content:center}
  .search{width:60%;min-width:260px;max-width:760px;background:#fff;border-radius:8px;padding:8px 12px;border:1px solid #eaeaea;display:flex;align-items:center}
  .search input{flex:1;border:0;outline:none;font-size:15px}
  .hamb{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:var(--brand);color:#fff;cursor:pointer}
  .container{max-width:1100px;margin:18px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
  .card{border:1px solid #eee;border-radius:8px;overflow:hidden;background:#fff;position:relative}
  .card .idBadge{position:absolute;right:8px;top:8px;background:var(--brand);color:#fff;padding:6px 8px;border-radius:6px;font-weight:700;font-size:12px}
  .card img{width:100%;height:200px;object-fit:cover;display:block}
  .priceBadge{position:absolute;left:8px;bottom:8px;background:var(--accent);color:#fff;padding:6px 10px;border-radius:6px;font-weight:700}
  .cardBody{padding:10px}
  .title{font-weight:700;margin-bottom:6px}
  .desc{font-size:13px;color:#444}
  .btn{margin-top:10px;padding:8px 10px;background:#111;color:#fff;border:none;border-radius:8px;cursor:pointer}
  /* modal */
  .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:50}
  .box{background:#fff;border-radius:10px;padding:16px;max-width:900px;width:94%;max-height:88vh;overflow:auto;display:flex;gap:16px}
  .leftImg{flex:1}
  .leftImg img{width:100%;height:auto;border-radius:8px}
  .rightInfo{flex:1;min-width:260px}
  .small{font-size:13px;color:#666;margin-top:8px}
  footer{padding:18px;text-align:center;color:#000;border-top:1px solid #eee;margin-top:24px}
  .footerLinks a{margin:0 8px;color:#000;text-decoration:none}
  /* profile panel */
  .profilePanel{position:fixed;right:10px;top:70px;background:#fff;border:1px solid #eee;padding:12px;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,0.08);display:none}
  .profilePanel h3{margin:0 0 8px 0}
</style>
</head>
<body>
  <div class="header">
    <div class="logo">SBA</div>
    <div class="searchWrap">
      <div class="search">
        <input id="searchInput" placeholder="Search SBA artifacts by id, owner, description..." />
      </div>
    </div>
    <div id="hamb" class="hamb">☰</div>
  </div>

  <div class="container">
    <div id="grid" class="grid"></div>
    <div id="empty" style="display:none;padding:40px;text-align:center;color:#666">No items found</div>
  </div>

  <!-- Modal detail -->
  <div id="modal" class="modal">
    <div class="box">
      <div class="leftImg">
        <img id="mImg" src="" alt="">
        <div style="margin-top:8px">
          <button id="buyBtn" class="btn">Buy</button>
        </div>
      </div>
      <div class="rightInfo">
        <h2 id="mId"></h2>
        <div style="font-weight:800;font-size:20px" id="mPrice"></div>
        <div class="small" id="mOwner"></div>
        <p id="mDesc" style="margin-top:12px"></p>
      </div>
    </div>
  </div>

  <!-- Registration modal -->
  <div id="regModal" class="modal">
    <div class="box" style="max-width:420px;flex-direction:column">
      <h3>Register to purchase</h3>
      <input id="regName" placeholder="Full name (as in passport)" style="padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:6px;width:100%">
      <input id="regTG" placeholder="Telegram ID (e.g. 123456789)" style="padding:8px;margin:8px 0;border:1px solid #ddd;border-radius:6px;width:100%">
      <div style="font-size:13px;color:#666">Get your Telegram ID from <a href="https://t.me/get_id_bot" target="_blank">@get_id_bot</a></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="regSubmit" class="btn">Register & Confirm</button>
        <button id="regCancel" class="btn" style="background:#eee;color:#111">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Profile panel -->
  <div id="profilePanel" class="profilePanel">
    <h3>Profile</h3>
    <div id="profileInfo">Not logged</div>
    <hr />
    <div><strong>Purchases</strong></div>
    <div id="purchases"></div>
  </div>

  <footer>
    <div class="footerLinks">
      <a href="#" target="_blank">Terms of Use</a> |
      <a href="#" target="_blank">Privacy Policy</a> |
      <a href="#" target="_blank">Disclaimer</a>
    </div>
  </footer>

<script>
/* >>>> ВАЖНО: вставь сюда URL твоего Apps Script Web App (API) */
const API_BASE = "https://script.google.com/macros/s/AKfycbyU4bJReAqt9ibiz67P4iLNnBp2BTpbqPjnwg8d_hFO1E7gQkeVAmI5G7jIc3WJsSPd/exec"; // <- замените на свой Web App URL

// утилиты
function formatPrice(n){
  if(n === null || n === undefined || n === "") return "";
  const num = Number(n) || 0;
  return "$" + num.toLocaleString('en-US');
}

async function api(action, payload){
  const url = API_BASE + (action ? ("?action=" + encodeURIComponent(action)) : "");
  const opts = {
    method: payload ? "POST" : "GET",
    headers: {'Content-Type': 'application/json'},
    body: payload ? JSON.stringify(payload) : undefined
  };
  const r = await fetch(url, opts);
  return await r.json();
}

// UI state
let artifacts = [];
let currentItem = null;
let loggedUser = null;

async function loadArtifacts(){
  const res = await api("getArtifacts");
  artifacts = Array.isArray(res) ? res : [];
  renderGrid(artifacts);
}

function renderGrid(items){
  const grid = document.getElementById('grid');
  grid.innerHTML = "";
  if(!items.length){
    document.getElementById('empty').style.display = 'block';
    return;
  } else document.getElementById('empty').style.display = 'none';

  items.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    const idBadge = document.createElement('div');
    idBadge.className = 'idBadge';
    idBadge.textContent = it.id;
    card.appendChild(idBadge);

    const img = document.createElement('img');
    img.src = it.image_url || '';
    card.appendChild(img);

    const priceBadge = document.createElement('div');
    priceBadge.className = 'priceBadge';
    priceBadge.textContent = formatPrice(it.price);
    card.appendChild(priceBadge);

    const body = document.createElement('div');
    body.className = 'cardBody';
    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = it.owner || it.id;
    const desc = document.createElement('div');
    desc.className = 'desc';
    desc.textContent = (it.description || "").slice(0,120) + (it.description && it.description.length>120 ? "…" : "");
    body.appendChild(title);
    body.appendChild(desc);
    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = 'Details';
    btn.onclick = ()=> openModal(it);
    body.appendChild(btn);
    card.appendChild(body);

    grid.appendChild(card);
  });
}

function openModal(it){
  currentItem = it;
  // When viewing inside details, ID badge should disappear — we show clean image in modal
  document.getElementById('mImg').src = it.image_url || '';
  document.getElementById('mId').textContent = it.id;
  document.getElementById('mPrice').textContent = formatPrice(it.price);
  document.getElementById('mOwner').textContent = "Creator: " + (it.owner || "") + " • TG: " + (it.telegram_id || "");
  document.getElementById('mDesc').textContent = it.description || "";
  document.getElementById('modal').style.display = 'flex';
}

function closeModal(){
  document.getElementById('modal').style.display = 'none';
  currentItem = null;
}

document.getElementById('modal').addEventListener('click', (e)=>{
  if(e.target === document.getElementById('modal')) closeModal();
});

// Buy button flow
document.getElementById('buyBtn').addEventListener('click', async ()=>{
  // if not logged -> show reg modal
  if(!loggedUser){
    document.getElementById('regModal').style.display = 'flex';
    return;
  }
  // perform createSale (simulation)
  await performPurchase();
});

document.getElementById('regCancel').addEventListener('click', ()=> document.getElementById('regModal').style.display = 'none');

document.getElementById('regSubmit').addEventListener('click', async ()=>{
  const name = document.getElementById('regName').value.trim();
  const tg = document.getElementById('regTG').value.trim();
  if(!name || !tg){ alert('Please enter full name and Telegram ID'); return; }
  // register via API
  const r = await api('registerUser', {action:'registerUser', fullName: name, telegram: tg});
  if(r && r.ok){
    loggedUser = {fullName: r.user.fullName, telegram: r.user.telegram, dateRegistered: r.user.dateRegistered};
    document.getElementById('regModal').style.display = 'none';
    renderProfile();
    // after registration, proceed to purchase automatically
    await performPurchase();
  } else {
    alert('Registration error: ' + (r.error || 'unknown'));
  }
});

async function performPurchase(){
  if(!currentItem || !loggedUser) return;
  // createSale payload
  const payload = {
    action: "createSale",
    sbaId: currentItem.id,
    buyerFullName: loggedUser.fullName,
    buyerTelegram: loggedUser.telegram,
    sellingPrice: currentItem.price,
    image_url: currentItem.image_url
  };
  const res = await api('createSale', payload);
  if(res && res.ok){
    alert('Purchase recorded. Sale ID: ' + res.saleId);
    // update UI: reload artifacts (owner changed/status sold)
    await loadArtifacts();
    closeModal();
    // refresh profile purchases
    await loadPurchases();
  } else {
    alert('Purchase error: ' + (res.error || 'unknown'));
  }
}

// Profile / hamburger
const hamb = document.getElementById('hamb');
hamb.addEventListener('click', ()=> {
  const panel = document.getElementById('profilePanel');
  panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
});

async function renderProfile(){
  const info = document.getElementById('profileInfo');
  if(!loggedUser){ info.innerHTML = 'Not registered'; return; }
  info.innerHTML = `<div><strong>${escapeHtml(loggedUser.fullName)}</strong></div><div class="small">TG: ${escapeHtml(loggedUser.telegram)}</div><div class="small">Registered: ${loggedUser.dateRegistered}</div>`;
  await loadPurchases();
}

async function loadPurchases(){
  if(!loggedUser) { document.getElementById('purchases').innerHTML = ''; return; }
  const res = await api('getSalesByTelegram', {action:'getSalesByTelegram', telegram: loggedUser.telegram});
  const cont = document.getElementById('purchases');
  cont.innerHTML = '';
  if(Array.isArray(res) && res.length){
    res.forEach(s=>{
      const d = document.createElement('div');
      d.style.borderTop = '1px solid #f0f0f0';
      d.style.paddingTop = '8px';
      d.innerHTML = `<div style="font-weight:700">${escapeHtml(s.sbaId)} — ${formatPrice(s.price)}</div><div class="small">${escapeHtml(s.date)}</div>`;
      cont.appendChild(d);
    });
  } else {
    cont.innerHTML = '<div class="small">No purchases yet</div>';
  }
}

// load logged user from localStorage if exists
function loadLocalUser(){
  try{
    const j = localStorage.getItem('sba_user');
    if(j){ loggedUser = JSON.parse(j); renderProfile(); }
  }catch(e){}
}
function saveLocalUser(){
  try{ localStorage.setItem('sba_user', JSON.stringify(loggedUser)); }catch(e){}
}

// when registering, store user locally
// modify register flow to store loggedUser
// update registerUser handler to save to localStorage
// we'll intercept registerUser response earlier to set loggedUser

// small helpers
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// Search
document.getElementById('searchInput').addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  if(!q) return renderGrid(artifacts);
  const filtered = artifacts.filter(i => {
    return (i.id||'').toLowerCase().includes(q) || (i.owner||'').toLowerCase().includes(q) || (i.description||'').toLowerCase().includes(q);
  });
  renderGrid(filtered);
});

// on load
(async function(){
  await loadArtifacts();
  loadLocalUser();
})();

// tweak registerUser handler to set loggedUser when register API returns
// override api() when called with registerUser action to set local loggedUser and save
const oldApi = api;
api = async function(action, payload){
  const res = await oldApi(action, payload);
  if(action === 'registerUser' && res && res.ok){
    loggedUser = {fullName: res.user.fullName, telegram: res.user.telegram, dateRegistered: res.user.dateRegistered};
    saveLocalUser();
  }
  return res;
};

</script>
</body>
</html>
